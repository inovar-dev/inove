import t from"node:http";import{parse as s}from"node:querystring";function e(t,s){if(t instanceof RegExp)return{keys:!1,pattern:t};var e,r,n,i,h=[],a="",d=t.split("/");for(d[0]||d.shift();n=d.shift();)"*"===(e=n[0])?(h.push("wild"),a+="/(.*)"):":"===e?(r=n.indexOf("?",1),i=n.indexOf(".",1),h.push(n.substring(1,~r?r:~i?i:n.length)),a+=~r&&!~i?"(?:/([^/]+?))?":"/([^/]+?)",~i&&(a+=(~r?"?":"")+"\\"+n.substring(i))):a+="/"+n;return{keys:h,pattern:new RegExp("^"+a+(s?"(?=$|/)":"/?$"),"i")}}const r={"":0,GET:1,HEAD:2,PATCH:3,OPTIONS:4,CONNECT:5,DELETE:6,TRACE:7,POST:8,PUT:9};class n{constructor(){this.routes=[],this.all=this.add.bind(this,""),this.get=this.add.bind(this,"GET"),this.head=this.add.bind(this,"HEAD"),this.patch=this.add.bind(this,"PATCH"),this.options=this.add.bind(this,"OPTIONS"),this.connect=this.add.bind(this,"CONNECT"),this.delete=this.add.bind(this,"DELETE"),this.trace=this.add.bind(this,"TRACE"),this.post=this.add.bind(this,"POST"),this.put=this.add.bind(this,"PUT")}use(t,...s){let n=[].concat.apply([],s),{keys:i,pattern:h}=e(t,!0);return this.routes.push({keys:i,pattern:h,method:"",handlers:n,midx:r[""]}),this}add(t,s,...n){let{keys:i,pattern:h}=e(s),a=[].concat.apply([],n);return this.routes.push({keys:i,pattern:h,method:t,handlers:a,midx:r[t]}),this}find(t,s){let e,n,i=r[t],h=2===i,a=0,d=0,o=this.routes,l=[],u={},p=[];for(;a<o.length;a++)if(n=o[a],n.midx===i||0===n.midx||h&&1===n.midx)if(!1===n.keys){if(l=n.pattern.exec(s),null===l)continue;if(void 0!==l.groups)for(e in l.groups)u[e]=l.groups[e];n.handlers.length>1?p=p.concat(n.handlers):p.push(n.handlers[0])}else if(n.keys.length>0){if(l=n.pattern.exec(s),null===l)continue;for(d=0;d<n.keys.length;)u[n.keys[d]]=l[++d];n.handlers.length>1?p=p.concat(n.handlers):p.push(n.handlers[0])}else n.pattern.test(s)&&(n.handlers.length>1?p=p.concat(n.handlers):p.push(n.handlers[0]));return{params:u,handlers:p}}}function i(t){return 47===t.charCodeAt(0)?t:"/"+t}function h(t){let s=t.indexOf("/",1);return s>1?t.substring(0,s):t}function a(t,s){s.url=s.url.substring(t.length)||"/",s.path=s.path.substring(t.length)||"/"}function d(s,e,r,n){let i=r.statusCode=s.code||s.status||500;"string"==typeof s||Buffer.isBuffer(s)?r.end(s):r.end(s.message||t.STATUS_CODES[i])}class o extends n{constructor(t={}){super(t),this.apps={},this.wares=[],this.bwares={},this.parse=function(t){var s=t.url;if(void 0===s)return s;var e=t._parsedUrl;if(e&&e._raw===s)return e;(e={}).query=e.search=null,e.href=e.path=e.pathname=s;var r=s.indexOf("?",1);return-1!==r&&(e.search=s.substring(r),e.query=e.search.substring(1),e.pathname=s.substring(0,r)),e._raw=s,t._parsedUrl=e}(),this.server=t.server,this.handler=this.handler.bind(this),this.onError=t.onError||d,this.onNoMatch=t.onNoMatch||this.onError.bind(null,{code:404})}add(t,s,...e){let r=i(h(s));if(void 0!==this.apps[r])throw new Error(`Cannot mount ".${t.toLowerCase()}('${i(s)}')" an application at ".use('${r}')"`);return super.add(t,s,...e)}use(t,...s){return"function"==typeof t?this.wares=this.wares.concat(t,s):"/"===t?this.wares=this.wares.concat(s):(t=i(t),s.forEach((s=>{if(s instanceof o)this.apps[t]=s;else{let e=this.bwares[t]||[];e.length>0||e.push(((s,e,r)=>(a(t,s),r()))),this.bwares[t]=e.concat(s)}}))),this}listen(){return(this.server=this.server||t.createServer()).on("request",this.handler),this.server.listen.apply(this.server,arguments),this}handler(t,e,r){r=r||this.parse(t);let n=[],i=this.wares,d=this.find(t.method,r.pathname);t.originalUrl=t.originalUrl||t.url;let o=h(t.path=r.pathname);void 0!==this.bwares[o]&&(i=i.concat(this.bwares[o])),d?(n=d.handlers,t.params=d.params):void 0!==this.apps[o]&&(a(o,t),r.pathname=t.path,n.push(this.apps[o].handler.bind(null,t,e,r))),n.push(this.onNoMatch),t.search=r.search,t.query=s(r.query);let l=0,u=i.length,p=n.length;if(u===l&&1===p)return n[0](t,e);let c=s=>s?this.onError(s,t,e,c):f(),f=s=>e.finished||l<u&&i[l++](t,e,c);i=i.concat(n),u+=p,f()}}const l=t=>new o(t);export{l as default};
//# sourceMappingURL=index.js.map
